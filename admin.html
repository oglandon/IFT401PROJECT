<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Proton Trading</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="styles.css">
        <link rel="stylesheet" href="adminuserlogin.css">
    </head>
    
    <body>
        <div id="wrapper">
            <header>
                <section id="top_bar">
                    <nav>
                        <ul>
                            <li><a href="index.html"> <img src="protonlogo.png" class="logo" alt="Proton Logo"></a></li>
                            <li><a href="about.html">About Us</a></li>
                            <li><a href="market.html">Market</a></li>
                            <li><a href="create.html">Create Account</a></li>
                            <li><a href="admin.html">Admin Login</a></li>
                            <li><a href="user.html">User Login</a></li>
                        </ul>
                    </nav>
                </section>
            </header>

            <div class="admin-login">
                <h2>Insert Admin Credentials.</h2>
                <form id="adminloginform">
                    <label for="email"></label>
                    <input type="text" id="email" name="email" required placeholder="Email">

                    <label for="password"></label>
                    <input type="password" id="password" name="password" required placeholder="Password">

                    <button type="submit">Login</button>
                </form>
            </div>

            <script>
                window.onload = function() {
                    document.getElementById("adminloginform").reset();
                };
            </script>
            <script>
                async function loginUser(username, password) {
                    const loginEndpoint = 'http://127.0.0.1:8000/user/token';
                    
                    try {
                        // Send POST request to /token endpoint to get the JWT token
                        const response = await fetch(loginEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                'username': username,
                                'password': password
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const accessToken = data.access_token;  // Extract token from response
                            localStorage.setItem('accessToken', accessToken);  // Store token for future use
                            alert('Login successful!');
                            return accessToken;  // Return the token
                        } else {
                            alert('Invalid credentials!');
                            throw new Error('Authentication failed');
                        }
                    } catch (error) {
                        console.error('Error logging in:', error);
                    }
                }

                // Function to access the admin-only resource (check admin privileges)
                async function accessAdminResource() {
                    const adminEndpoint = 'http://127.0.0.1:8000/user/admin-only';
                    const token = localStorage.getItem('accessToken');  // Retrieve token from local storage

                    if (!token) {
                        alert('You need to log in first!');
                        return;
                    }

                    try {
                        // Send GET request to the /admin-only endpoint with the token in the Authorization header
                        const response = await fetch(adminEndpoint, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,  // Attach the token for authorization
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            console.log('Admin data:', data);  // Successfully accessed the admin resource
                            
                            // Store user/admin data in localStorage or sessionStorage
                            localStorage.setItem('adminData', JSON.stringify(data));

                            // Redirect to the admin account page
                            window.location.href = 'adminaccount.html';
                        } else if (response.status === 403) {
                            alert('You do not have admin privileges!');
                        } else {
                            alert('Unauthorized access or session expired!');
                        }
                    } catch (error) {
                        console.error('Error accessing admin resource:', error);
                    }
                }

                // Example usage:
                document.getElementById('loginForm').addEventListener('submit', async (event) => {
                    event.preventDefault();

                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;

                    const token = await loginUser(username, password);

                    if (token) {
                        // After successful login, try to access the admin resource
                        await accessAdminResource();
                    }
                });
            </script>